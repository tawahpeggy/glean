<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Ping Encryption Plugin - Glean - Cross-platform Telemetry library</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../../../favicon.svg">
        
        
        <link rel="shortcut icon" href="../../../favicon.png">
        
        <link rel="stylesheet" href="../../../css/variables.css">
        <link rel="stylesheet" href="../../../css/general.css">
        <link rel="stylesheet" href="../../../css/chrome.css">
        
        <link rel="stylesheet" href="../../../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../../../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../../../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../../highlight.css">
        <link rel="stylesheet" href="../../../tomorrow-night.css">
        <link rel="stylesheet" href="../../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
        <link rel="stylesheet" href="../../../../shared/glean.css">
        
        <link rel="stylesheet" href="../../../../shared/mermaid.css">
        

        
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item affix "><a href="../../../index.html">Glean</a></li><li class="chapter-item affix "><li class="part-title">User Guides</li><li class="chapter-item "><a href="../../../user/adding-glean-to-your-project/index.html"><strong aria-hidden="true">1.</strong> Adding Glean to your project</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../user/adding-glean-to-your-project/kotlin.html"><strong aria-hidden="true">1.1.</strong> Kotlin</a></li><li class="chapter-item "><a href="../../../user/adding-glean-to-your-project/swift.html"><strong aria-hidden="true">1.2.</strong> Swift</a></li><li class="chapter-item "><a href="../../../user/adding-glean-to-your-project/python.html"><strong aria-hidden="true">1.3.</strong> Python</a></li><li class="chapter-item "><a href="../../../user/adding-glean-to-your-project/javascript.html"><strong aria-hidden="true">1.4.</strong> JavaScript</a></li><li class="chapter-item "><a href="../../../user/adding-glean-to-your-project/qt.html"><strong aria-hidden="true">1.5.</strong> Qt/QML</a></li></ol></li><li class="chapter-item "><a href="../../../user/integrating-glean-for-product-managers.html"><strong aria-hidden="true">2.</strong> Integrating Glean for project managers</a></li><li class="chapter-item "><a href="../../../user/metrics/adding-new-metrics.html"><strong aria-hidden="true">3.</strong> Metrics</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../user/metrics/adding-new-metrics.html"><strong aria-hidden="true">3.1.</strong> Adding new metrics</a></li><li class="chapter-item "><a href="../../../user/metrics/testing-metrics.html"><strong aria-hidden="true">3.2.</strong> Testing metrics</a></li><li class="chapter-item "><a href="../../../user/metrics/error-reporting.html"><strong aria-hidden="true">3.3.</strong> Error reporting</a></li><li class="chapter-item "><a href="../../../user/collected-metrics/metrics.html"><strong aria-hidden="true">3.4.</strong> Metrics collected by the Glean SDK</a></li></ol></li><li class="chapter-item "><a href="../../../user/pings/index.html"><strong aria-hidden="true">4.</strong> Pings</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../user/pings/custom.html"><strong aria-hidden="true">4.1.</strong> Adding new custom pings</a></li><li class="chapter-item "><a href="../../../user/pings/testing-custom-pings.html"><strong aria-hidden="true">4.2.</strong> Testing custom pings</a></li><li class="chapter-item "><a href="../../../user/pings/sent-by-glean.html"><strong aria-hidden="true">4.3.</strong> Pings sent by Glean</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../user/pings/baseline.html"><strong aria-hidden="true">4.3.1.</strong> Baseline Ping</a></li><li class="chapter-item "><a href="../../../user/pings/deletion_request.html"><strong aria-hidden="true">4.3.2.</strong> Deletion Request Ping</a></li><li class="chapter-item "><a href="../../../user/pings/events.html"><strong aria-hidden="true">4.3.3.</strong> Events Ping</a></li><li class="chapter-item "><a href="../../../user/pings/metrics.html"><strong aria-hidden="true">4.3.4.</strong> Metrics Ping</a></li><li class="chapter-item "><a href="../../../user/pings/ping-schedules-and-timings.html"><strong aria-hidden="true">4.3.5.</strong> Schedules and timings overview</a></li></ol></li></ol></li><li class="chapter-item "><a href="../../../user/debugging/index.html"><strong aria-hidden="true">5.</strong> Debugging products using Glean</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../user/debugging/android.html"><strong aria-hidden="true">5.1.</strong> Android</a></li><li class="chapter-item "><a href="../../../user/debugging/ios.html"><strong aria-hidden="true">5.2.</strong> iOS</a></li><li class="chapter-item "><a href="../../../user/debugging/python.html"><strong aria-hidden="true">5.3.</strong> Python</a></li><li class="chapter-item "><a href="../../../user/debugging/javascript.html"><strong aria-hidden="true">5.4.</strong> JavaScript</a></li></ol></li><li class="chapter-item "><li class="part-title">API Reference</li><li class="chapter-item "><a href="../../../reference/yaml/index.html"><strong aria-hidden="true">6.</strong> YAML Registry Format</a></li><li class="chapter-item "><a href="../../../reference/general/index.html"><strong aria-hidden="true">7.</strong> General API</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../reference/general/initializing.html"><strong aria-hidden="true">7.1.</strong> Initializing</a></li><li class="chapter-item "><a href="../../../reference/general/toggling-upload-status.html"><strong aria-hidden="true">7.2.</strong> Toggling upload status</a></li><li class="chapter-item "><a href="../../../reference/general/experiments-api.html"><strong aria-hidden="true">7.3.</strong> Annotating experiments</a></li><li class="chapter-item "><a href="../../../reference/general/register-custom-pings.html"><strong aria-hidden="true">7.4.</strong> Registering custom pings</a></li></ol></li><li class="chapter-item "><a href="../../../reference/debug/index.html"><strong aria-hidden="true">8.</strong> Debugging</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../reference/debug/logPings.html"><strong aria-hidden="true">8.1.</strong> Log pings</a></li><li class="chapter-item "><a href="../../../reference/debug/debugViewTag.html"><strong aria-hidden="true">8.2.</strong> Debug View Tag</a></li><li class="chapter-item "><a href="../../../reference/debug/sourceTags.html"><strong aria-hidden="true">8.3.</strong> Source Tags</a></li></ol></li><li class="chapter-item "><a href="../../../reference/metrics/index.html"><strong aria-hidden="true">9.</strong> Metric types</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../reference/metrics/boolean.html"><strong aria-hidden="true">9.1.</strong> Boolean</a></li><li class="chapter-item "><a href="../../../reference/metrics/labeled_booleans.html"><strong aria-hidden="true">9.2.</strong> Labeled Booleans</a></li><li class="chapter-item "><a href="../../../reference/metrics/counter.html"><strong aria-hidden="true">9.3.</strong> Counter</a></li><li class="chapter-item "><a href="../../../reference/metrics/labeled_counters.html"><strong aria-hidden="true">9.4.</strong> Labeled Counters</a></li><li class="chapter-item "><a href="../../../reference/metrics/string.html"><strong aria-hidden="true">9.5.</strong> String</a></li><li class="chapter-item "><a href="../../../reference/metrics/labeled_strings.html"><strong aria-hidden="true">9.6.</strong> Labeled Strings</a></li><li class="chapter-item "><a href="../../../reference/metrics/string_list.html"><strong aria-hidden="true">9.7.</strong> String List</a></li><li class="chapter-item "><a href="../../../reference/metrics/timespan.html"><strong aria-hidden="true">9.8.</strong> Timespan</a></li><li class="chapter-item "><a href="../../../reference/metrics/timing_distribution.html"><strong aria-hidden="true">9.9.</strong> Timing Distribution</a></li><li class="chapter-item "><a href="../../../reference/metrics/memory_distribution.html"><strong aria-hidden="true">9.10.</strong> Memory Distribution</a></li><li class="chapter-item "><a href="../../../reference/metrics/uuid.html"><strong aria-hidden="true">9.11.</strong> UUID</a></li><li class="chapter-item "><a href="../../../reference/metrics/datetime.html"><strong aria-hidden="true">9.12.</strong> Datetime</a></li><li class="chapter-item "><a href="../../../reference/metrics/event.html"><strong aria-hidden="true">9.13.</strong> Event</a></li><li class="chapter-item "><a href="../../../reference/metrics/custom_distribution.html"><strong aria-hidden="true">9.14.</strong> Custom Distribution</a></li><li class="chapter-item "><a href="../../../reference/metrics/quantity.html"><strong aria-hidden="true">9.15.</strong> Quantity</a></li><li class="chapter-item "><a href="../../../reference/metrics/rate.html"><strong aria-hidden="true">9.16.</strong> Rate</a></li></ol></li><li class="chapter-item "><a href="../../../reference/pings/index.html"><strong aria-hidden="true">10.</strong> Pings</a></li><li class="chapter-item affix "><li class="part-title">Language Bindings Information</li><li class="chapter-item "><a href="../../../language-bindings/index.html"><strong aria-hidden="true">11.</strong> Overview</a></li><li class="chapter-item "><a href="../../../language-bindings/android/index.html"><strong aria-hidden="true">12.</strong> Android</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../language-bindings/android/android-build-configuration-options.html"><strong aria-hidden="true">12.1.</strong> Android build configuration options</a></li><li class="chapter-item "><a href="../../../language-bindings/android/android-offline-builds.html"><strong aria-hidden="true">12.2.</strong> Android offline builds</a></li><li class="chapter-item "><a href="../../../language-bindings/android/instrument-android-crashes-example.html"><strong aria-hidden="true">12.3.</strong> Instrumenting Android crashes with the Glean SDK</a></li></ol></li><li class="chapter-item expanded "><a href="../../../language-bindings/javascript/index.html"><strong aria-hidden="true">13.</strong> JavaScript</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../language-bindings/javascript/plugins/index.html"><strong aria-hidden="true">13.1.</strong> Plugins</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../language-bindings/javascript/plugins/encryption.html" class="active"><strong aria-hidden="true">13.1.1.</strong> Ping Encryption Plugin</a></li></ol></li></ol></li><li class="chapter-item "><li class="part-title">Appendix</li><li class="chapter-item "><a href="../../../appendix/glossary.html"><strong aria-hidden="true">14.</strong> Glossary</a></li><li class="chapter-item "><a href="../../../appendix/changelog/index.html"><strong aria-hidden="true">15.</strong> Changelog</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../appendix/changelog/sdk.html"><strong aria-hidden="true">15.1.</strong> Glean SDK</a></li><li class="chapter-item "><a href="../../../appendix/changelog/js.html"><strong aria-hidden="true">15.2.</strong> Glean.js</a></li></ol></li><li class="chapter-item "><a href="../../../appendix/twig.html"><strong aria-hidden="true">16.</strong> This Week in Glean</a></li><li class="chapter-item "><a href="../../../appendix/contribution-guidelines.html"><strong aria-hidden="true">17.</strong> Contribution Guidelines</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Glean - Cross-platform Telemetry library</h1>

                    <div class="right-buttons">
                        
                        <a href="../../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                        <a href="https://github.com/mozilla/glean" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#pingencryptionplugin" id="pingencryptionplugin">PingEncryptionPlugin</a></h1>
<p>The <code>PingEncryptionPlugin</code> encrypts the pings payloads before pings are sent.</p>
<p>The encryption happens after a ping is collected and before it is sent, the scope
of this plugin does not include data encryption <em>before</em> collection. In other words,
Glean will still store plain data on the user's machine and the data will only be
encrypted during transit.</p>
<p>Encrypted pings will not be compliant with the usual <a href="https://github.com/mozilla-services/mozilla-pipeline-schemas/blob/main/schemas/glean/glean/glean.1.schema.json">Glean ping schema</a>.
Instead they will follow a specific encrypted ping schema that looks like this:</p>
<pre><code class="language-js">{
  &quot;payload&quot;: &quot;eyJhbGciOiJFQ0RILUVTI...&quot;
}
</code></pre>
<p>The schema has one field, <code>payload</code>, which is an unbounded string containing the output of the
encryption of the common Glean payload. Since JSON is the supported transport for our data ingestion
platform, the encrypted payload will be in the <a href="https://tools.ietf.org/html/rfc7516#section-3.1">JWE Compact Serialization</a>
format and must include a key id (<code>kid</code>) header identifying the public key used for encryption.
A matching key is derived from the document namespace that uniquely identifies the application
instead of the key id derived from the public key.</p>
<h2><a class="header" href="#requesting-an-encryption-key" id="requesting-an-encryption-key">Requesting an encryption key</a></h2>
<p>The encryption key is provisioned by Data SRE and must be generated before new pings can be
successfully ingested into a data store. <strong>Without a valid encryption key, the Glean pipeline will</strong>
<strong>not be able to parse the pings and they will be thrown into the error stream.</strong></p>
<p>The encryption key should be requested as part of the process of adding a Glean application id to the ingestion pipeline (see <a href="../../../user/adding-glean-to-your-project/index.html">this checklist</a>).</p>
<h2><a class="header" href="#usage" id="usage">Usage</a></h2>
<h3><a class="header" href="#entry-point" id="entry-point">Entry point</a></h3>
<pre><code class="language-js">//esm
import PingEncryptionPlugin from &quot;@mozilla/glean/plugins/encryption&quot;
// cjs
const { default: PingEncryptionPlugin } = require(&quot;@mozilla/glean/plugins/encryption&quot;);
</code></pre>
<h3><a class="header" href="#instantiating" id="instantiating">Instantiating</a></h3>
<p>The <code>PingEncryptionPlugin</code> constructor expects a
<a href="https://datatracker.ietf.org/doc/html/rfc7516#section-4.1.5">JWK</a> as a parameter.
This JWK is the key provided by Data SRE during the
<a href="#requesting-an-encryption-key">&quot;Requesting an encryption key&quot;</a> step.</p>
<pre><code class="language-js">Glean.initialize({
  &quot;my.fancy.encrypted.app&quot;,
  uploadStatus,
  {
    plugins: [
         new PingEncryptionPlugin({
              &quot;crv&quot;: &quot;P-256&quot;,
              &quot;kid&quot;: &quot;fancy&quot;,
              &quot;kty&quot;: &quot;EC&quot;,
              &quot;x&quot;: &quot;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&quot;,
              &quot;y&quot;: &quot;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&quot;
         })
    ]
  }
});
</code></pre>
<div class="special-quote special-quote-info fa fa-info-circle"></div>
<h4><a class="header" href="#note-on-logpings" id="note-on-logpings">Note on <code>logPings</code></a></h4>
<blockquote>
<p>The <a href="../../../reference/debug/logPings.html">logPings</a> debug feature can still be used if
ping encryption is turned on. Pings will be logged in their plain format,
right before encryption happens.</p>
</blockquote>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/glean/edit/main/docs/user/language-bindings/javascript/plugins/encryption.md">Edit this file on GitHub.</a></footer>
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../../../language-bindings/javascript/plugins/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../../../appendix/glossary.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../../../language-bindings/javascript/plugins/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../../../appendix/glossary.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        <script type="text/javascript" src="../../../../shared/tabs.js"></script>
        
        <script type="text/javascript" src="../../../../shared/mermaid.min.js"></script>
        
        <script type="text/javascript" src="../../../../shared/mermaid-init.js"></script>
        
        <script type="text/javascript" src="../../../chart.min.js"></script>
        
        <script type="text/javascript" src="../../../chart-distributions.js"></script>
        
        <script type="text/javascript" src="../../../chart-distributions-ui.js"></script>
        

        

    </body>
</html>
